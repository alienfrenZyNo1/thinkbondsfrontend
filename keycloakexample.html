<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Keycloak Standard Flow Test</title>
    <style>
      body {
        font-family: sans-serif;
        line-height: 1.6;
        padding: 2em;
      }
      pre {
        background-color: #f4f4f4;
        padding: 1em;
        border-radius: 5px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      button {
        font-size: 1.1em;
        padding: 0.5em 1em;
        margin-top: 1em;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      #logout-button {
        background-color: #f44336;
        color: white;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Keycloak Standard Flow Test for 'Domino-WebApp'</h1>

      <div id="login-section">
        <p>Click the button below to start the login process.</p>
        <button id="login-button">Login with Keycloak</button>
      </div>

      <div id="result-section" style="display: none">
        <h2>Authentication Successful!</h2>
        <p>Here is the Access Token received from Keycloak:</p>
        <pre id="access-token"></pre>
        <button id="api-button">Call Domino API</button>
        <button id="logout-button">Logout</button>
        <!-- NEW LOGOUT BUTTON -->
        <p>API Response:</p>
        <pre id="api-response">
Click the 'Call Domino API' button to test...</pre
        >
      </div>

      <div id="error-section" style="display: none">
        <h2>An Error Occurred</h2>
        <pre id="error-message" class="error"></pre>
      </div>

      <!-- NEW LOGGED OUT MESSAGE -->
      <div id="logout-section" style="display: none">
        <h2>You have been successfully logged out.</h2>
        <p><a href="/">Click here to log in again.</a></p>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      const keycloakBaseUrl = 'https://idp.pixu.bid/realms/DemoRealm';
      const clientId = 'Domino-WebApp';
      const redirectUri = window.location.origin + window.location.pathname; // Dynamically get the base URL
      const dominoApiUrl =
        'https://dp5.dominopeople.ie:8880/api/v1/lists/bonds?dataSource=bonds';
      // --- END CONFIGURATION ---

      const ui = {
        loginSection: document.getElementById('login-section'),
        resultSection: document.getElementById('result-section'),
        errorSection: document.getElementById('error-section'),
        logoutSection: document.getElementById('logout-section'), // NEW
        loginButton: document.getElementById('login-button'),
        apiButton: document.getElementById('api-button'),
        logoutButton: document.getElementById('logout-button'), // NEW
        accessToken: document.getElementById('access-token'),
        apiResponse: document.getElementById('api-response'),
        errorMessage: document.getElementById('error-message'),
      };

      // ... (Helper functions generateRandomString and generateCodeChallenge are the same) ...
      function generateRandomString(length) {
        let text = '';
        const possible =
          'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234456789';
        for (let i = 0; i < length; i++) {
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
      }
      async function generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        return window
          .btoa(String.fromCharCode(...new Uint8Array(digest)))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=/g, '');
      }

      // 1. Kicks off the login process
      async function login() {
        const codeVerifier = generateRandomString(50);
        sessionStorage.setItem('pkce_code_verifier', codeVerifier);
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        const authUrl =
          `${keycloakBaseUrl}/protocol/openid-connect/auth?` +
          `client_id=${encodeURIComponent(clientId)}` +
          `&redirect_uri=${encodeURIComponent(redirectUri)}` +
          `&response_type=code` +
          `&scope=${encodeURIComponent('openid email profile $DATA bonds')}` +
          `&code_challenge=${encodeURIComponent(codeChallenge)}` +
          `&code_challenge_method=S256`;
        window.location.href = authUrl;
      }

      // --- NEW LOGOUT FUNCTION ---
      // 5. Kicks off the logout process
      function logout() {
        sessionStorage.clear(); // Clear local tokens
        const logoutUrl =
          `${keycloakBaseUrl}/protocol/openid-connect/logout?` +
          `client_id=${encodeURIComponent(clientId)}` +
          `&post_logout_redirect_uri=${encodeURIComponent(redirectUri)}` +
          `&ui_locales=en`; // Added locale for consistency

        window.location.href = logoutUrl;
      }

      // ... (exchangeCodeForToken and callApi are the same) ...
      async function exchangeCodeForToken(code) {
        const codeVerifier = sessionStorage.getItem('pkce_code_verifier');
        if (!codeVerifier) {
          showError(
            'Code verifier was not found in session storage. Please try logging in again.'
          );
          return;
        }
        const tokenUrl = `${keycloakBaseUrl}/protocol/openid-connect/token`;
        const params = new URLSearchParams();
        params.append('grant_type', 'authorization_code');
        params.append('client_id', clientId);
        params.append('redirect_uri', redirectUri.split('?')[0]);
        params.append('code', code);
        params.append('code_verifier', codeVerifier);
        try {
          const response = await fetch(tokenUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params,
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error_description || 'Failed to fetch token');
          }
          sessionStorage.setItem('access_token', data.access_token);
          showResult(data.access_token);
        } catch (error) {
          showError(error.message);
        }
      }
      async function callApi() {
        const token = sessionStorage.getItem('access_token');
        if (!token) {
          showError('No access token found. Please log in.');
          return;
        }
        ui.apiResponse.textContent = 'Calling API...';
        try {
          const response = await fetch(dominoApiUrl, {
            method: 'GET',
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(JSON.stringify(data, null, 2));
          }
          ui.apiResponse.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          ui.apiResponse.textContent = `API Call Failed:\n${error.message}`;
        }
      }

      // --- UI Update Functions ---
      function showResult(token) {
        ui.loginSection.style.display = 'none';
        ui.logoutSection.style.display = 'none';
        ui.resultSection.style.display = 'block';
        ui.accessToken.textContent = token;
      }
      function showError(message) {
        ui.loginSection.style.display = 'none';
        ui.resultSection.style.display = 'none';
        ui.errorSection.style.display = 'block';
        ui.errorMessage.textContent = message;
      }
      function showLogoutScreen() {
        ui.loginSection.style.display = 'none';
        ui.resultSection.style.display = 'none';
        ui.logoutSection.style.display = 'block';
      }

      // --- MAIN LOGIC ---
      // 2. Checks the URL for login codes or logout status
      window.onload = () => {
        ui.loginButton.onclick = login;
        ui.apiButton.onclick = callApi;
        ui.logoutButton.onclick = logout; // NEW

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state'); // Keycloak often adds a state param on logout redirect

        if (code) {
          // We have a login code, so exchange it for a token.
          exchangeCodeForToken(code);
        } else if (sessionStorage.getItem('access_token')) {
          // We have a token from a previous load, show the result screen
          showResult(sessionStorage.getItem('access_token'));
        } else if (state) {
          // If there's no code but there's a state, we likely just came back from a logout.
          showLogoutScreen();
        }
      };
    </script>
  </body>
</html>
